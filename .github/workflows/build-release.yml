name: Build & Release 单文件可执行包

on:
  push:
    branches: [ master ]          # 也可加 pull_request:
  workflow_dispatch:            # 手动触发按钮

permissions:
  contents: write

jobs:
  build:
    strategy:
      matrix:
        rid: [ win-x64 ]   # 需要更多 RID 继续加
    runs-on: windows-latest
    steps:
      # 1. 拉代码
      - uses: actions/checkout@v4

      # 2. 装 .NET 8 SDK（支持 --self-contained 单文件发布）
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      # 3. 还原 & 编译
      - name: Restore
        run: dotnet restore

      - name: Build
        run: dotnet build -c Release --no-restore

      # 4. 发布（Self-Contained & Framework-Dependent）
      - name: Publish Self-Contained
        run: |
          dotnet publish CyberNote.csproj `
            -c Release `
            --self-contained true `
            -p:PublishSingleFile=true `
            -p:IncludeNativeLibrariesForSelfExtract=true `
            -r ${{ matrix.rid }} `
            -o pub/${{ matrix.rid }}-sc

      - name: Publish Framework-Dependent
        run: |
          dotnet publish CyberNote.csproj `
            -c Release `
            --self-contained false `
            -p:PublishSingleFile=true `
            -r ${{ matrix.rid }} `
            -o pub/${{ matrix.rid }}-fd

      # 5. 打包
      - name: Package
        run: |
          Compress-Archive -Path pub\${{ matrix.rid }}-sc\* -DestinationPath ${{ matrix.rid }}-self-contained.zip
          Compress-Archive -Path pub\${{ matrix.rid }}-fd\* -DestinationPath ${{ matrix.rid }}-framework-dependent.zip

      # 6. 上传成品到 GitHub Release（自动创建标签）
      - name: Release
        uses: softprops/action-gh-release@v2
        if: github.ref == 'refs/heads/master'
        with:
          tag_name: v1 #固定为v1版本
          name: Release ${{ github.run_number }}
          files: |
            ${{ matrix.rid }}-self-contained.zip
            ${{ matrix.rid }}-framework-dependent.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
