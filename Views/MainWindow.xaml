<Window x:Class="CyberNote.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml" xmlns:views="clr-namespace:CyberNote.Views"
        Title="CyberNote 桌面组件"
        Width="350"
        Height="250"
        WindowStyle="None"
        ResizeMode="NoResize"
        Background="Transparent"
        AllowsTransparency="True"
        Topmost="True"
        ShowInTaskbar="False"
        x:Name="MainWin"
        LocationChanged="Window_LocationChanged"
        Loaded="Window_Loaded">

    <Window.Resources>
        <!-- 无边框平滑按钮样式 -->
        <Style x:Key="FlatButton" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderBrush" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Padding" Value="4,2"/>
            <Setter Property="Foreground" Value="#333"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}" CornerRadius="4" SnapsToDevicePixels="True">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Background" Value="#FFE8F5E9"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter Property="Background" Value="#FFC8E6C9"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter Property="Foreground" Value="#999"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- 供缩略卡片按钮使用的无边框样式放到 Window.Resources，确保 DataTemplate 可解析 -->
        <Style x:Key="CardButtonStyle" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderBrush" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Padding" Value="0"/>
            <Setter Property="FocusVisualStyle" Value="{x:Null}"/>
            <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
            <Setter Property="VerticalContentAlignment" Value="Stretch"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <ContentPresenter HorizontalAlignment="{TemplateBinding HorizontalContentAlignment}" VerticalAlignment="{TemplateBinding VerticalContentAlignment}"/>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </Window.Resources>

    <!-- 使用圆角裁剪整个窗口区域，避免外部黑色阴影 -->
    <Grid>
        <Grid.Clip>
            <RectangleGeometry RadiusX="12" RadiusY="12" Rect="0,0,350,250" />
        </Grid.Clip>
        <Border CornerRadius="12" BorderThickness="2" BorderBrush="#DDDDDD" Background="#FFFFFF" Padding="8" MouseLeftButtonDown="DragBorder_MouseLeftButtonDown" SnapsToDevicePixels="True" ClipToBounds="True">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="*" />
                    <RowDefinition Height="Auto" />
                </Grid.RowDefinitions>
                <ContentControl x:Name="HeaderContent" Grid.Row="0" HorizontalAlignment="Stretch" VerticalAlignment="Stretch" Content="{Binding MainCardElement}"/>
                <Button Grid.Row="1" Content="选择卡片" Height="20" Style="{StaticResource FlatButton}" Click="ExtendBtn_Clicked" x:Name="ExpendBtn"/>
            </Grid>
        </Border>

        <!-- ✅ 用 Popup 实现“外部更宽面板” -->
        <Popup x:Name="WidePopup" Placement="Bottom" PlacementTarget="{Binding ElementName=ExpendBtn}" VerticalOffset="5" StaysOpen="True" IsOpen="False" AllowsTransparency="True">
            <Border Background="#FFFFFF" BorderBrush="#DDDDDD" BorderThickness="2" CornerRadius="12" Padding="10" SnapsToDevicePixels="True">
                <Grid>
                    <ScrollViewer VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">
                        <ItemsControl ItemsSource="{Binding ThumbnailCards}">
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <!-- 每行两个缩略卡片 -->
                                    <UniformGrid Columns="2" />
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>
                            <ItemsControl.ItemContainerStyle>
                                <Style TargetType="ContentPresenter">
                                    <Setter Property="Margin" Value="8"/>
                                </Style>
                            </ItemsControl.ItemContainerStyle>
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Button Style="{StaticResource CardButtonStyle}" Command="{Binding DataContext.ReplaceMainCard, RelativeSource={RelativeSource AncestorType=ItemsControl}}" CommandParameter="{Binding}">
                                        <views:ThumbnailCard Type="{Binding Type}" CreateDate="{Binding CreateDate}" Title="{Binding Title}" ContentPreview="{Binding ContentPreview}" />
                                    </Button>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </ScrollViewer>
                    <!-- 悬浮新增按钮 -->
                    <Button Background="#4CAF50" 
                            Width="40" 
                            Height="40" 
                            BorderThickness="0"
                            Click="FloatingButton_Click" 
                            HorizontalAlignment="Right" 
                            VerticalAlignment="Bottom" 
                            Margin="0,0,8,8" 
                            Panel.ZIndex="1" 
                            Cursor="Hand">
                        <Button.Template>
                            <ControlTemplate TargetType="Button">
                                <Border Background="{TemplateBinding Background}" 
                                        CornerRadius="20" 
                                        SnapsToDevicePixels="True">
                                    <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                </Border>
                                <ControlTemplate.Triggers>
                                    <Trigger Property="IsMouseOver" Value="True">
                                        <Setter Property="Background" Value="#45A049"/>
                                    </Trigger>
                                    <Trigger Property="IsPressed" Value="True">
                                        <Setter Property="Background" Value="#3D8B40"/>
                                    </Trigger>
                                </ControlTemplate.Triggers>
                            </ControlTemplate>
                        </Button.Template>
                        <TextBlock Text="＋" FontSize="18" FontWeight="Bold" Foreground="White" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                    </Button>
                </Grid>
            </Border>
        </Popup>

        <!-- ✅ 新增：卡片类型选择 Popup -->
        <Popup x:Name="TypeSelectorPopup" 
               Placement="Bottom" 
               PlacementTarget="{Binding ElementName=ExpendBtn}" 
               VerticalOffset="5" 
               HorizontalOffset="280"
               StaysOpen="False" 
               IsOpen="False" 
               AllowsTransparency="True">
            <Border Background="#FFFFFF" 
                    BorderBrush="#4CAF50" 
                    BorderThickness="2" 
                    CornerRadius="8" 
                    Padding="12" 
                    SnapsToDevicePixels="True">
                <Border.Effect>
                    <DropShadowEffect Color="Black" 
                                      BlurRadius="10" 
                                      ShadowDepth="2" 
                                      Opacity="0.3"/>
                </Border.Effect>
                <StackPanel>
                    <TextBlock Text="选择卡片类型" 
                               FontWeight="Bold" 
                               FontSize="14" 
                               Foreground="#333" 
                               Margin="0,0,0,10"/>
                    
                    <!-- 随手记类型 -->
                    <Button Style="{StaticResource FlatButton}" 
                            Height="40" 
                            Margin="0,0,0,8"
                            Tag="Common"
                            Click="CardTypeButton_Click">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="📝" FontSize="18" Margin="0,0,8,0"/>
                            <TextBlock Text="随手记" FontSize="14" VerticalAlignment="Center"/>
                        </StackPanel>
                    </Button>
                    
                    <!-- 任务列表类型 -->
                    <Button Style="{StaticResource FlatButton}" 
                            Height="40"
                            Tag="List"
                            Click="CardTypeButton_Click">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="✓" FontSize="18" Margin="0,0,8,0"/>
                            <TextBlock Text="任务列表" FontSize="14" VerticalAlignment="Center"/>
                        </StackPanel>
                    </Button>
                    
                    <!-- 可以继续添加更多类型 -->
                </StackPanel>
            </Border>
        </Popup>
    </Grid>
</Window>