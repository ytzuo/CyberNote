<Window x:Class="CyberNote.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml" xmlns:views="clr-namespace:CyberNote.Views"
        Title="CyberNote 桌面组件"
        Width="350"
        Height="250"
        WindowStyle="None"
        ResizeMode="NoResize"
        Background="Transparent"
        AllowsTransparency="True"
        Topmost="True"
        ShowInTaskbar="False"
        x:Name="MainWin"
        LocationChanged="Window_LocationChanged"
        Loaded="Window_Loaded">

    <Window.Resources>
        <!-- 无边框平滑按钮样式 -->
        <Style x:Key="FlatButton" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderBrush" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Padding" Value="4,2"/>
            <Setter Property="Foreground" Value="#333"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}" CornerRadius="4" SnapsToDevicePixels="True">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Background" Value="#FFE8F5E9"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter Property="Background" Value="#FFC8E6C9"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter Property="Foreground" Value="#999"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- 供缩略卡片按钮使用的无边框样式放到 Window.Resources，确保 DataTemplate 可解析 -->
        <Style x:Key="CardButtonStyle" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderBrush" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Padding" Value="0"/>
            <Setter Property="FocusVisualStyle" Value="{x:Null}"/>
            <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
            <Setter Property="VerticalContentAlignment" Value="Stretch"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <ContentPresenter HorizontalAlignment="{TemplateBinding HorizontalContentAlignment}" VerticalAlignment="{TemplateBinding VerticalContentAlignment}"/>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </Window.Resources>

    <!-- 使用圆角裁剪整个窗口区域，避免外部黑色阴影 -->
    <Grid>
        <Grid.Clip>
            <RectangleGeometry RadiusX="12" RadiusY="12" Rect="0,0,350,250" />
        </Grid.Clip>
        <Border CornerRadius="12" BorderThickness="2" BorderBrush="#DDDDDD" Background="#FFFFFF" Padding="8" MouseLeftButtonDown="DragBorder_MouseLeftButtonDown" SnapsToDevicePixels="True" ClipToBounds="True">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="*" />
                    <RowDefinition Height="Auto" />
                </Grid.RowDefinitions>
                <ContentControl x:Name="HeaderContent" Grid.Row="0" HorizontalAlignment="Stretch" VerticalAlignment="Stretch" Content="{Binding MainCardElement}"/>
                <Button Grid.Row="1" Content="选择卡片" Height="20" Style="{StaticResource FlatButton}" Click="ExtendBtn_Clicked" x:Name="ExpendBtn"/>
            </Grid>
        </Border>

        <!-- ✅ 用 Popup 实现"外部更宽面板" -->
        <Popup x:Name="WidePopup" Placement="Bottom" PlacementTarget="{Binding ElementName=ExpendBtn}" VerticalOffset="5" StaysOpen="True" IsOpen="False" AllowsTransparency="True">
            <Border Background="#FFFFFF" BorderBrush="#DDDDDD" BorderThickness="2" CornerRadius="12" Padding="10" SnapsToDevicePixels="True" MaxHeight="400">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <!-- ✅ 顶部搜索栏与筛选/排序按钮 -->
                    <Grid Grid.Row="0" Margin="0,0,0,8">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        
                        <!-- 搜索框 -->
                        <Border Grid.Column="0" BorderBrush="#DDDDDD" BorderThickness="1" CornerRadius="4" Background="#FAFAFA" Margin="0,0,0,0">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Grid.Column="0" Text="🔍" FontSize="14" VerticalAlignment="Center" Margin="6,0,4,0" Foreground="#888"/>
                                <TextBox x:Name="SearchBox" 
                                         Grid.Column="1" 
                                         BorderThickness="0" 
                                         Background="Transparent" 
                                         VerticalAlignment="Center" 
                                         FontSize="13" 
                                         Padding="4,6"
                                         Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}"
                                         ToolTip="搜索标题或内容"/>
                            </Grid>
                        </Border>
                        
                        <!-- 按种类筛选按钮（点击循环切换：全部 → 随手记 → 任务列表 → 全部...） -->
                        <Button x:Name="FilterTypeButton" 
                                Grid.Column="1" 
                                Style="{StaticResource FlatButton}" 
                                Width="80" 
                                Height="28" 
                                Margin="0,0,4,0"
                                Click="FilterTypeButton_Click"
                                ToolTip="按种类筛选（点击切换）">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock x:Name="typeFont" Text="≡" FontSize="12" Margin="0,0,4,0"/>
                                <TextBlock x:Name="FilterTypeText" Text="全部" FontSize="12" VerticalAlignment="Center"/>
                            </StackPanel>
                        </Button>
                        
                        <!-- 按日期排序按钮（点击切换：降序 ↔ 升序） -->
                        <Button x:Name="SortDateButton" 
                                Grid.Column="2" 
                                Style="{StaticResource FlatButton}" 
                                Width="80" 
                                Height="28"
                                Click="SortDateButton_Click"
                                ToolTip="按日期排序（点击切换）">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="📅" FontSize="12" Margin="0,0,4,0"/>
                                <TextBlock x:Name="SortDateText" Text="降序" FontSize="12" VerticalAlignment="Center"/>
                            </StackPanel>
                        </Button>
                    </Grid>

                    <!-- 卡片列表 -->
                    <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Visible" HorizontalScrollBarVisibility="Disabled" MaxHeight="280" CanContentScroll="False">
                        <ItemsControl ItemsSource="{Binding ThumbnailCardsView}">
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <!-- 每行两个缩略卡片 -->
                                    <UniformGrid Columns="2" />
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>
                            <ItemsControl.ItemContainerStyle>
                                <Style TargetType="ContentPresenter">
                                    <Setter Property="Margin" Value="8"/>
                                </Style>
                            </ItemsControl.ItemContainerStyle>
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Button Style="{StaticResource CardButtonStyle}" 
                                            Command="{Binding DataContext.ReplaceMainCard, RelativeSource={RelativeSource AncestorType=ItemsControl}}" 
                                            CommandParameter="{Binding}">
                                        <views:ThumbnailCard Type="{Binding Type}" 
                                                             CreateDate="{Binding CreateDate}" 
                                                             Title="{Binding Title}" 
                                                             ContentPreview="{Binding ContentPreview}" />
                                        <!-- 右键菜单：删除（使用 x:Reference MainWin 以跨可视树绑定到窗口 DataContext） -->
                                        <Button.ContextMenu>
                                            <ContextMenu>
                                                <MenuItem Header="删除便签"
                                                          Command="{Binding DataContext.DeleteCard, Source={x:Reference MainWin}}"
                                                          CommandParameter="{Binding PlacementTarget.DataContext, RelativeSource={RelativeSource AncestorType=ContextMenu}}"/>
                                            </ContextMenu>
                                        </Button.ContextMenu>
                                    </Button>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </ScrollViewer>

                    <!-- 悬浮新增按钮 -->
                    <Button Grid.Row="1" Background="#4CAF50" 
                            Width="40" 
                            Height="40" 
                            BorderThickness="0"
                            Click="FloatingAddButton_Click" 
                            HorizontalAlignment="Right" 
                            VerticalAlignment="Bottom" 
                            Margin="0,0,8,8" 
                            Panel.ZIndex="1" 
                            Cursor="Hand">
                        <Button.Template>
                            <ControlTemplate TargetType="Button">
                                <Border Background="{TemplateBinding Background}" 
                                        CornerRadius="20" 
                                        SnapsToDevicePixels="True">
                                    <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                </Border>
                                <ControlTemplate.Triggers>
                                    <Trigger Property="IsMouseOver" Value="True">
                                        <Setter Property="Background" Value="#45A049"/>
                                    </Trigger>
                                    <Trigger Property="IsPressed" Value="True">
                                        <Setter Property="Background" Value="#3D8B40"/>
                                    </Trigger>
                                </ControlTemplate.Triggers>
                            </ControlTemplate>
                        </Button.Template>
                        <TextBlock Text="＋" FontSize="18" FontWeight="Bold" Foreground="White" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                    </Button>

                    <!-- 悬浮设置按钮 -->
                    <Button Grid.Row="1" Background="#4CAF50" 
                            Width="40" 
                            Height="40" 
                            BorderThickness="0"
                            Click="FloatingOptionButton_Click" 
                            HorizontalAlignment="Right" 
                            VerticalAlignment="Bottom" 
                            Margin="0,0,56,8" 
                            Panel.ZIndex="1" 
                            Cursor="Hand">
                        <Button.Template>
                            <ControlTemplate TargetType="Button">
                                <Border Background="{TemplateBinding Background}" 
                                        CornerRadius="20" 
                                        SnapsToDevicePixels="True">
                                    <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                </Border>
                                <ControlTemplate.Triggers>
                                    <Trigger Property="IsMouseOver" Value="True">
                                        <Setter Property="Background" Value="#45A049"/>
                                    </Trigger>
                                    <Trigger Property="IsPressed" Value="True">
                                        <Setter Property="Background" Value="#3D8B40"/>
                                    </Trigger>
                                </ControlTemplate.Triggers>
                            </ControlTemplate>
                        </Button.Template>
                        <TextBlock Text="⚙️" FontSize="18" FontWeight="Bold" Foreground="White" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                    </Button>

                    <!-- 悬浮动态按钮 -->
                    <Button Grid.Row="1" Background="#4CAF50" 
                            Width="40" 
                            Height="40" 
                            BorderThickness="0"
                            Click="FloatingActivityButton_Click" 
                            HorizontalAlignment="Right" 
                            VerticalAlignment="Bottom" 
                            Margin="0,0,104,8" 
                            Panel.ZIndex="1" 
                            Cursor="Hand">
                        <Button.Template>
                            <ControlTemplate TargetType="Button">
                                <Border Background="{TemplateBinding Background}" 
                                        CornerRadius="20" 
                                        SnapsToDevicePixels="True">
                                    <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                </Border>
                                <ControlTemplate.Triggers>
                                    <Trigger Property="IsMouseOver" Value="True">
                                        <Setter Property="Background" Value="#45A049"/>
                                    </Trigger>
                                    <Trigger Property="IsPressed" Value="True">
                                        <Setter Property="Background" Value="#3D8B40"/>
                                    </Trigger>
                                </ControlTemplate.Triggers>
                            </ControlTemplate>
                        </Button.Template>
                        <TextBlock Text="📅" FontSize="18" FontWeight="Bold" Foreground="White" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                    </Button>
                </Grid>
            </Border>
        </Popup>

        <!-- ✅ 新增：卡片类型选择 Popup -->
        <Popup x:Name="TypeSelectorPopup" 
               Placement="Bottom" 
               PlacementTarget="{Binding ElementName=ExpendBtn}" 
               VerticalOffset="5" 
               HorizontalOffset="280"
               StaysOpen="False" 
               IsOpen="False" 
               AllowsTransparency="True">
            <Border Background="#FFFFFF" 
                    BorderBrush="#4CAF50" 
                    BorderThickness="2" 
                    CornerRadius="8" 
                    Padding="12" 
                    SnapsToDevicePixels="True">
                <Border.Effect>
                    <DropShadowEffect Color="Black" 
                                      BlurRadius="10" 
                                      ShadowDepth="2" 
                                      Opacity="0.3"/>
                </Border.Effect>
                <StackPanel>
                    <TextBlock Text="选择卡片类型" 
                               FontWeight="Bold" 
                               FontSize="14" 
                               Foreground="#333" 
                               Margin="0,0,0,10"/>
                    
                    <!-- 随手记类型 -->
                    <Button Style="{StaticResource FlatButton}" 
                            Height="40" 
                            Margin="0,0,0,8"
                            Tag="Common"
                            Click="CardTypeButton_Click">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="📝" FontSize="18" Margin="0,0,8,0"/>
                            <TextBlock Text="随手记" FontSize="14" VerticalAlignment="Center"/>
                        </StackPanel>
                    </Button>
                    
                    <!-- 任务列表类型 -->
                    <Button Style="{StaticResource FlatButton}" 
                            Height="40"
                            Tag="List"
                            Click="CardTypeButton_Click">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="✓" FontSize="18" Margin="0,0,8,0"/>
                            <TextBlock Text="任务列表" FontSize="14" VerticalAlignment="Center"/>
                        </StackPanel>
                    </Button>

                    <!-- 富文本类型 -->
                    <Button Style="{StaticResource FlatButton}" 
                            Height="40"
                            Tag="RichText"
                            Click="CardTypeButton_Click">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="🅡" FontSize="18" Margin="0,0,8,0"/>
                            <TextBlock Text="富文本" FontSize="14" VerticalAlignment="Center"/>
                        </StackPanel>
                    </Button>

                    <!-- 可以继续添加更多类型 -->
                </StackPanel>
            </Border>
        </Popup>

        <!-- ✅ 设置 Popup -->
        <Popup x:Name="OptionPopup" 
            Placement="Bottom" 
            PlacementTarget="{Binding ElementName=ExpendBtn}" 
            VerticalOffset="5" 
            HorizontalOffset="280"
            StaysOpen="False" 
            IsOpen="False" 
            AllowsTransparency="True">
                <Border Background="#FFFFFF" 
                    BorderBrush="#4CAF50" 
                    BorderThickness="2" 
                    CornerRadius="8" 
                    Padding="12" 
                    SnapsToDevicePixels="True">
                    <Border.Effect>
                        <DropShadowEffect Color="Black" 
                              BlurRadius="10" 
                              ShadowDepth="2" 
                              Opacity="0.3"/>
                    </Border.Effect>
                    <StackPanel>
                        <TextBlock Text="选项" 
                            FontWeight="Bold" 
                            FontSize="14" 
                            Foreground="#333" 
                            Margin="0,0,0,10"/>

                        <!-- 修改文件路径 -->
                        <Button Style="{StaticResource FlatButton}" 
                                Height="40"
                                Tag="List"
                                Click="ChangePathButton_Click">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="📄" FontSize="18" Margin="0,0,8,0"/>
                            <TextBlock Text="修改便签文件路径" FontSize="14" VerticalAlignment="Center"/>
                        </StackPanel>
                    </Button>

                </StackPanel>
            </Border>
        </Popup>

        <!-- ✅ 新增：活动热力图 Popup -->
        <!-- Placement="Right" relative to MainWin -->
        <Popup x:Name="ActivityPopup" 
               Placement="Right" 
               PlacementTarget="{Binding ElementName=MainWin}" 
               HorizontalOffset="10" 
               VerticalOffset="0"
               StaysOpen="True" 
               IsOpen="False" 
               AllowsTransparency="True">
            <Border Background="#FFFFFF" 
                    BorderBrush="#DDDDDD" 
                    BorderThickness="1" 
                    CornerRadius="8" 
                    Padding="8" 
                    SnapsToDevicePixels="True">
                <Border.Effect>
                    <DropShadowEffect Color="Black" BlurRadius="5" ShadowDepth="1" Opacity="0.2"/>
                </Border.Effect>
                <Grid>
                    <!-- 提示标题 -->
                    <TextBlock Text="每日热力图" FontSize="10" Foreground="#999" Margin="2,0,0,4" HorizontalAlignment="Left" VerticalAlignment="Top"/>
                    
                    <ItemsControl ItemsSource="{Binding HeatMapItems}" Margin="0,18,0,0">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <!-- 垂直WrapPanel：高度 = 7 * (12+4) = 112px，确保每列7个 -->
                                <WrapPanel Orientation="Vertical" Height="112" />
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Border Width="12" Height="12" Margin="2" Background="{Binding Color}" CornerRadius="2" ToolTipService.InitialShowDelay="0">
                                    <Border.InputBindings>
                                        <MouseBinding Gesture="LeftDoubleClick" 
                                                      Command="{Binding DataContext.HeatMapItemClickCommand, RelativeSource={RelativeSource AncestorType=ItemsControl}}" 
                                                      CommandParameter="{Binding}"/>
                                    </Border.InputBindings>
                                    <Border.Style>
                                        <Style TargetType="Border">
                                            <Style.Triggers>
                                                <Trigger Property="IsMouseOver" Value="True">
                                                    <Setter Property="RenderTransform">
                                                        <Setter.Value>
                                                            <ScaleTransform ScaleX="1.4" ScaleY="1.4" CenterX="6" CenterY="6"/>
                                                        </Setter.Value>
                                                    </Setter>
                                                    <Setter Property="Panel.ZIndex" Value="100"/>
                                                    <Setter Property="BorderBrush" Value="#666"/>
                                                    <Setter Property="BorderThickness" Value="1"/>
                                                </Trigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Border.Style>
                                    <Border.ToolTip>
                                        <ToolTip>
                                            <StackPanel Margin="4">
                                                <TextBlock Text="{Binding Date, StringFormat=yyyy-MM-dd}" FontWeight="Bold"/>
                                                <Separator Margin="0,4"/>
                                                <StackPanel Orientation="Horizontal">
                                                    <TextBlock Text="便签: " Foreground="#666"/>
                                                    <TextBlock Text="{Binding Count}"/>
                                                </StackPanel>
                                                <StackPanel Orientation="Horizontal">
                                                    <TextBlock Text="心情: " Foreground="#666"/>
                                                    <TextBlock Text="{Binding Mood}"/>
                                                </StackPanel>
                                                <TextBlock Text="{Binding NoteSummary}" Margin="0,4,0,0" FontStyle="Italic" MaxWidth="150" TextWrapping="Wrap"/>
                                            </StackPanel>
                                        </ToolTip>
                                    </Border.ToolTip>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </Grid>
            </Border>
        </Popup>
    </Grid>
</Window>